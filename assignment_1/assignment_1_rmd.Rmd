---
title: "Assignment 1"
author: "Ted Ladas - s2124289"
date: "27/02/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list = ls())
library(MARSS)
library(rjags)
```

```{r b}
data(graywhales)
# print(graywhales)
missing.data <- matrix(data=c(1986,1988,1989,1990,1991,1994,1996,NA,NA,NA,NA,NA,NA,NA), ncol=2, byrow=FALSE)
graywhales <- as.matrix(rbind(graywhales, missing.data))
graywhales <- graywhales[order(graywhales[,1]),]

model0 = "model{
  x.0  ~ dnorm(log(2500), 1)
  x[1] ~ dnorm(beta * x.0 + u, inv.sigma02)
  y[1] ~ dnorm(x[1], inv.ita02)
  
  for (t in 2:n){
     mu[t] = beta*x[t-1] + u
     x[t] ~ dnorm(mu[t], inv.sigma02)
     y[t] ~ dnorm(x[t], inv.ita02)
  } 
  
  beta ~ dunif(0,1)
  u ~ dexp(1)
  inv.sigma02 ~ dgamma(0.1,0.1)
  inv.ita02 ~ dgamma(0.1,0.1)
  sigma2 = 1/inv.sigma02
  ita2 = 1/inv.ita02
}"

n=dim(graywhales)[1]
coef = c('beta','u','sigma2','ita2')
burn.in = 2*1e3
jm0 = jags.model(textConnection(model0), data=list(n=n, y=log(graywhales[,2])), n.chains=3)
update(jm0, burn.in, progress.bar='none')
res = coda.samples(jm0, variable.names=coef, n.iter=5e3, thin=500)
```

```{r c}
gelman.diag(res)
round(effectiveSize(res),2)
par(mfrow=c(2,2))
acf(res[[1]][,"beta"])
acf(res[[1]][,"u"])
acf(res[[1]][,"sigma2"])
acf(res[[1]][,"ita2"])
```

```{r d}
summary(res)
plot(res)
beta.den = res[[1]][,1]
ita2.den = res[[1]][,2]
sigma2.den = res[[1]][,3]
u.den = res[[1]][,4]
#par(mfrow=c(2,2))
x = seq(0,1,by=0.001)
y = dunif(x, min=0, max=1)
plot(beta.den, trace=FALSE, density=TRUE, col='blue4', main='Beta')
lines(x, y, type='l', col='red4')
x = seq(0,3.1,by=0.001)
y = dexp(x, rate=1)
plot(u.den, trace=FALSE, density=TRUE, col='blue4', main='u')
lines(x, y, type='l', col='red4')
x = seq(0,1,by=0.001)
y = dgamma(x, shape=0.1, rate=0.1)
plot(sigma2.den, trace=FALSE, density=TRUE, col='blue4', main='Sigma2')
lines(x, y, type='l', col='red4')
y = dgamma(x, shape=0.1, rate=0.1)
plot(ita2.den, trace=FALSE, density=TRUE, col='blue4', main='Ita2')
lines(x, y, type='l', col='red4')
```

```{r e}
model1 = "model{
  x.0  ~ dnorm(log(2500), 1)
  x[1] ~ dnorm(beta * x.0 + u, inv.sigma02)
  y[1] ~ dnorm(x[1], inv.ita02)
  
  for (t in 2:n){
     mu[t] = beta*x[t-1] + u
     x[t] ~ dnorm(mu[t], inv.sigma02)
     y[t] ~ dnorm(x[t], inv.ita02)
  } 
  
  beta ~ dunif(beta.start,beta.end)
  u ~ dexp(u.shape)
  inv.sigma02 ~ dgamma(sigma.shape,sigma.rate)
  inv.ita02 ~ dgamma(ita.shape,ita.rate)
  sigma2 = 1/inv.sigma02
  ita2 = 1/inv.ita02
}"

beta.start <- -1
beta.end <- 2
u.shape <- 3
sigma.shape <- 1/0.1
sigma.rate <- 1/0.1
ita.shape <- 1/0.1
ita.rate <- 1/0.1

jm1 = jags.model(textConnection(model1),
                 data=list(n=n,
                           y=log(graywhales[,2]),
                           beta.start=0,
                           beta.end=1,
                           u.shape=1,
                           sigma.shape=0.1,
                           sigma.rate=0.1,
                           ita.shape=0.1,
                           ita.rate=0.1),
                 n.chains=3)
update(jm1,
       burn.in,
       progress.bar='none')
res1 = coda.samples(jm1,
                   variable.names=coef,
                   n.iter=5e3,
                   thin=500)

summary(res1)
summary(res)
gelman.diag(res1)
round(effectiveSize(res1),2)
acf(res1[[1]][,"beta"])
acf(res1[[1]][,"u"])
acf(res1[[1]][,"sigma2"])
acf(res1[[1]][,"ita2"])
```

```{r f}
p.years <- as.matrix(cbind(seq(1998,2050,by=1), rep(NA,53)),ncol=2,byrow=FALSE)
graywhales.p <- rbind(graywhales, p.years)
n=dim(graywhales.p)[1]
coef = c('x')

jm0 = jags.model(textConnection(model0), data=list(n=n, y=log(graywhales.p[,2])), n.chains=3)
update(jm0, burn.in, progress.bar='none')
res = coda.samples(jm0, variable.names=coef, n.iter=5e6, thin=500)
summary(res)

plot(graywhales.p[,1], summary(res)[[1]][,1],
     ylab='Log population',
     xlab='Years',
     type='l',
     col='blue4',
     ylim=c(7.9,12.5))
lines(graywhales.p[,1], summary(res)[[2]][,1],
      lty=2,
      col='pink',
      lwd=2)
lines(graywhales.p[,1], summary(res)[[2]][,5],
      lty=2,
      col='pink',
      lwd=2)
legend('topleft', legend=c("log-population", "95% symetric CI"),
       col=c("blue4", "pink"),
       lty=c(1,2,2),
       cex=0.8)

# probability calculation pending
```

```{r g}

```