---
title: "Assignment2"
author: "Ted Ladas - s2124289"
date: "30/03/2021"
output: html_document
---

```{r setup, include=FALSE}
rm(list=ls())
knitr::opts_chunk$set(echo = TRUE)
library(rjags)
library(INLA)
library(dplyr)
library(data.table)
library(ggplot2)
library("ggpubr")
library(ggcorrplot)
library(gridExtra)
```

```{r 1.a(i)}
load(file='./earthScot.RData')
earthQ <- data.table(earthQ)

# EDA
numcols <- sapply(earthQ, is.numeric) 
cor.earthQ <- cor(earthQ, use="pairwise.complete")
ggcorrplot(cor.earthQ,
           hc.order=TRUE,
           type="lower",
           lab=TRUE)

plot <- earthQ %>% 
  filter(!is.na(`nrUK>4.5`))

plot %>%
  ggplot(aes(dist, eartScot,
             size=MLrUK,
             color=`nrUK>4.5`)) +
  geom_point() +
  geom_smooth(method="glm",
              formula='y~x',
              se=FALSE)

plot %>%
  ggplot(aes(decade, eartScot,
             size=MLrUK,
             color=`nrUK>4.5`)) +
  geom_point() +
  geom_smooth(method="glm",
              formula='y~x',
              se=FALSE)

plot %>%
  ggplot(., aes(eartrUK, eartScot,
                size=MLrUK,
                color=`nrUK>4.5`)) +
  geom_point() +
  geom_smooth(method="glm",
              formula='y~x',
              se=FALSE)

```

```{r 1.a(ii)}

a1 <- glm(eartScot~eartrUK, data=earthQ, family=poisson(link = "log"))
summary(a1)

earthQ %>% 
  ggplot(., aes(eartrUK, eartScot)) +
  geom_point(size=3) +
  geom_smooth(method="glm",
              formula='y~x',
              method.args=list(family=poisson(link="log")),
              se=T,
              aes(color="red4"), linetype="dashed") +
  labs(title = "Poisson Regression",
       subtitle = NULL,
       caption = NULL,
       tag = NULL,
       #x = NULL,
       #y = NULL,
       colour = "Regression") +
  theme_minimal()

# coefficients of regression after unlinking
a1.coef.unlinked <- a1 %>% coef() %>% exp()
# earthquakes during 70s and 80s
a1.fited <- a1 %>% predict(., type="response")
earthquakes.70.80 <- NULL
earthquakes.70.80 <- cbind(c(1970,1980),a1.fited[7:8])

a1.coef.unlinked
earthquakes.70.80


earthQ %>%
  dplyr::select(eartScot,eartrUK, decade) %>%
  mutate(eartScot.pred.a1 = a1.fited) %>%
  ggplot() +
  geom_point(aes(x=decade, y=eartScot, color='Actual')) +
  geom_line(aes(x=decade, y=eartScot, color='Actual')) +
  geom_point(aes(x=decade, y=eartScot.pred.a1, color='a1 Prediction')) +
  geom_line(aes(x=decade, y=eartScot.pred.a1, color='a1 Prediction')) +
  labs(title="GLM fit predictions",
       color=NULL) +
  theme_minimal()

```

```{r 1.b(model.s)}
model.s <- "model{
  # Hyperparameters
  a.0 <- a        
  b.0 <- b

  # prior
  lambda ~ dgamma(a.0,b.0)

 #Likelihood
  for(i in 1:n) {
      mu[i]  <- lambda*eartrUK[i]
      eartScot[i] ~ dpois(mu[i])
    } 
  }"
inits <- list(list(lambda=10^0),
              list(lambda=10^1),
              list(lambda=10^2),
              list(lambda=10^3),
              list(lambda=10^4))
```

```{r 1.b(i)}
b1.data <- list(n=length(earthQ$eartrUK),
               eartScot=earthQ$eartScot,
               eartrUK =earthQ$eartrUK,
               a=0.01,
               b=0.01)

fit.b1 <- jags.model(file=textConnection(model.s),
                     data=b1.data, 
                     inits=inits,
                     n.chains=5)
update(fit.b1, n.iter=7000)
results.b1 <- coda.samples(fit.b1,
                           variable.names=c("lambda"),
                           n.iter=1e4)

# convergence and summary statistics for b1
plot(results.b1)
summary(results.b1)
gelman.diag(results.b1)
gelman.plot(results.b1)
round(effectiveSize(results.b1),2)
acf(results.b1[[1]][,"lambda"])
```

```{r 1.b(ii)}
b2.data <- list(n=length(earthQ$eartrUK),
               eartScot=earthQ$eartScot,
               eartrUK =earthQ$eartrUK,
               a=16,
               b=20)

fit.b2 <- jags.model(file=textConnection(model.s),
                     data=b2.data,
                     inits=inits,
                     n.chains=5)
update(fit.b2, n.iter=7000)
results.b2 <- coda.samples(fit.b2,
                           variable.names=c("lambda"),
                           n.iter=1e4)


# convergence and summary statistics for b2
plot(results.b2)
summary(results.b2)
gelman.diag(results.b2)
gelman.plot(results.b2)
round(effectiveSize(results.b2),2)
acf(results.b2[[1]][,"lambda"])
```

```{r 1.b(model.h)}
model.h <- "model{
 # Deterministic
  sigma2 = 1/tau

 # Hyperpriors
  a.0 ~ dlnorm(log(a), tau)
  b.0 ~ dlnorm(log(b), tau)
  
 # Prior
  lambda ~ dgamma(a.0,b.0)

 # Likelihood
  for(i in 1:n) {
      mu[i]  <- lambda*eartrUK[i]
      eartScot[i] ~ dpois(mu[i])
    } 
  }"
inits <- list(list(lambda=10^0),
              list(lambda=10^1),
              list(lambda=10^2),
              list(lambda=10^3),
              list(lambda=10^4))
```

```{r 1.b(iii)}
b3.data <- list(n=length(earthQ$eartrUK),
               eartScot=earthQ$eartScot,
               eartrUK =earthQ$eartrUK,
               a=2,
               b=4,
               tau=log(1.64))

fit.b3 <- jags.model(file=textConnection(model.h),
                     data=b3.data, 
                     inits=inits,
                     n.chains=5)
update(fit.b3, n.iter=6000)
results.b3 <- coda.samples(fit.b3,
                           variable.names=c("lambda", "a.0", "b.0"),
                           n.iter=1e5,
                           thin=50)

# convergence and summary statistics for b3
plot(results.b3)
summary(results.b3)
gelman.diag(results.b3)
gelman.plot(results.b3)
round(effectiveSize(results.b3),2)
acf(results.b3[[1]][,"lambda"])
acf(results.b3[[1]][,"a.0"])
acf(results.b3[[1]][,"b.0"])
```

```{r 1.c(model.c1)}
model.c1 <- "model{
 # prior
  beta0 ~ dnorm(0,1/5)
  beta1 ~ dnorm(0,1/5)

 # Likelihood
  for(i in 1:n) {
      log(mu[i]) <- beta0+beta1*(dist[i]-mean(dist[]))
      eartScot[i] ~ dpois(mu[i])
    } 
  }"
```

```{r 1.c}
c1.data <- list(n=length(earthQ$eartrUK),
               eartScot=earthQ$eartScot,
               dist =earthQ$dist)

fit.c1 <- jags.model(file=textConnection(model.c1),
                     data=c1.data, 
                     inits=inits,
                     n.chains=5)
update(fit.c1, n.iter=6000)
results.c1 <- coda.samples(fit.c1,
                           variable.names=c("beta0", "beta1"),
                           n.iter=1e4,
                           thin=5)

# convergence and summary statistics for c1
plot(results.c1)
summary(results.c1)
gelman.diag(results.c1)
gelman.plot(results.c1)
round(effectiveSize(results.c1),2)
acf(results.c1[[1]][,"beta0"])
acf(results.c1[[1]][,"beta1"])
```

```{r 1.d(model.d1)}
model.d1 <- "model{
 # Likelihood
  for(i in 1:n) {
      delta[i] ~ dnorm(0,tau.delta)
      log(mu[i]) <- beta0+beta1*(dist[i]-mean(dist[])) + delta[i]
      eartScot[i] ~ dpois(mu[i])
  } 
    
 # prior
  beta0 ~ dnorm(0,1/5)
  beta1 ~ dnorm(0,1/5)
  tau.delta <- pow(sigma.delta, -2)
  sigma.delta ~ dunif(0,5)
  }"
```

```{r 1.d}
d1.data <- list(n=length(earthQ$eartrUK),
               eartScot=earthQ$eartScot,
               dist=earthQ$dist)

fit.d1 <- jags.model(file=textConnection(model.d1),
                     data=d1.data, 
                     inits=inits,
                     n.chains=5)
update(fit.d1, n.iter=6000)
results.d1 <- coda.samples(fit.d1,
                           variable.names=c("beta0", "beta1", "sigma.delta"),
                           n.iter=1e5,
                           thin=100)

# convergence and summary statistics for c1
plot(results.d1)
summary(results.d1)
gelman.diag(results.d1)
gelman.plot(results.d1)
round(effectiveSize(results.d1),2)
acf(results.d1[[1]][,"beta0"])
acf(results.d1[[1]][,"beta1"])
acf(results.d1[[1]][,"sigma.delta"])
```



```{r 1.e(model.e1)}
model.e1 <- "model{
 # prior
  beta0 ~ dnorm(0,1/5)
  beta1 ~ dnorm(0,1/5)

 # Likelihood
  for(i in 1:n) {
      log(mu[i]) <- beta0+beta1*(nrUK[i]-mean(nrUK[]))
      eartScot[i] ~ dpois(mu[i])
    } 
  }"
```


```{r 1.e imputation}
imputation <- glm(`nrUK>4.5`~ MLrUK, data=earthQ, family=poisson(link = "log"))
earthQ.imp <- earthQ %>% 
  mutate(`nrUK>4.5` = ifelse(is.na(`nrUK>4.5`),
                             round(predict(imputation, type="response"),0),
                              `nrUK>4.5`))
earthQ.imp

```


```{r 1.e}
e1.data <- list(n=length(earthQ.imp$eartrUK),
               eartScot=earthQ.imp$eartScot,
               nrUK =earthQ.imp$`nrUK>4.5`)

fit.e1 <- jags.model(file=textConnection(model.e1),
                     data=e1.data, 
                     inits=inits,
                     n.chains=5)
update(fit.e1, n.iter=6000)
results.e1 <- coda.samples(fit.e1,
                           variable.names=c("beta0", "beta1"),
                           n.iter=1e4,
                           thin=5)

# convergence and summary statistics for e1
plot(results.e1)
summary(results.e1)
gelman.diag(results.e1)
gelman.plot(results.e1)
round(effectiveSize(results.e1),2)
acf(results.e1[[1]][,"beta0"])
acf(results.e1[[1]][,"beta1"])
```

```{r 1.e(model.e2)}
model.e2 <- "model{
 # prior
  beta0 ~ dnorm(0,1/5)
  beta1 ~ dnorm(0,1/5)
  
 # Likelihood
  for(i in 1:n) {
      nrUK[i]  ~ dgamma(a.nrUK, b.nrUK)
      log(mu[i]) <- beta0+beta1*(nrUK[i]-mean(nrUK[]))
      eartScot[i] ~ dpois(mu[i])
    } 
  }"
```

```{r test}
# x <- seq(0, 5, length.out=1000)
# cv = 0.4
# cv^(-2)
# 
# dat <- data.frame(x=x, px=dgamma(x, shape = cv^(-2), rate = cv^(-2)-1))
# ggplot(dat, aes(x=x, y=px)) + geom_line()
```


```{r 1.e2}
e2.data <- list(n=length(earthQ.imp$eartrUK),
               eartScot=earthQ.imp$eartScot,
               nrUK =earthQ.imp$`nrUK>4.5`,
               a.nrUK=6.25,
               b.nrUK=5.25) # a and b chosen for mean 1 and CV 0.4

fit.e2 <- jags.model(file=textConnection(model.e2),
                     data=e2.data, 
                     inits=inits,
                     n.chains=5)
update(fit.e2, n.iter=6000)
results.e2 <- coda.samples(fit.e2,
                           variable.names=c("beta0", "beta1"),
                           n.iter=1e4,
                           thin=5)

# convergence and summary statistics for e1
#diagMCMC(results.e2)
plot(results.e2)
summary(results.e2)
gelman.diag(results.e2)
gelman.plot(results.e2)
round(effectiveSize(results.e2),2)
acf(results.e2[[1]][,"beta0"])
acf(results.e2[[1]][,"beta1"])
```


```{r 1.e posterior predictive}
e2.params <- results.e2 %>% as.matrix(.) %>% as.data.frame(.) %>% exp(.)
e2.estimates <- colMeans(e2.params)

beta.prior <- rnorm(dim(e2.params)[1], mean=0, sd=sqrt(5))
e2.params %>%
  mutate(beta.prior = beta.prior) %>%
  ggplot() +
  geom_density(aes(beta0), fill="red4", colour="red4", alpha=0.6) +
  geom_density(aes(beta1), fill="blue4", colour="blue4", alpha=0.6) +
  geom_density(aes(beta.prior), fill="green4", colour="green4", alpha=0.6) +
  theme(axis.title.x = element_blank()) + 
  ggtitle(expression(paste("Posterior Densities of ", beta_0," and ", beta_1))) +
  #geom_text(aes(label=c("1","2","3")))

# round(e2.estimates[1] + e2.estimates[2]*earthQ.imp$`nrUK>4.5`,0) # Earthquakes according to model e2
set.seed(2)
mu.post.e2 <- e2.estimates[1] + e2.estimates[2]*earthQ.imp$`nrUK>4.5`
ynew.e2 <- as.data.frame(rpois(12, mu.post.e2))
# y.e2 %>% mutate(ynew.e2=ynew.e2+rep(1,12))


earthQ %>%
  ggplot() +
  geom_point(aes(x=decade, y=eartScot)) +
  geom_line(aes(x=decade, y=eartScot))
# plot(y,
#      main = "Posterior Predictive Distribution",
#      xlab = "y")
```



- `Region` for Bejaia and Sidi Bel-abbes
- `month` from June to September 2012
- `TempCels` Daily temperature in Celsius
- `RH` Daily relative Humidity (%)
- `Ws` Daily wind speed (Km/h)
- `RainYest` Yesterday's precipitations (mm/m^2) 
- `DMC` The Duff Moisture Code is a numeric rating of the average moisture content of loosely compacted organic layers of moderate depth in the forest. It is part of the Canadian Forest Fire Weather Index (FWI).
- `Fire` Absence/presence (0/1) of a wildfire.

```{r 2.a}
AlgForest <- read.csv('./AlgForest.csv')
AlgForest <- data.table(AlgForest)

AlgForest <- AlgForest %>%
  mutate(Fire = as.factor(Fire))


p1 <- AlgForest %>%
  ggplot(aes(x=TempCels, y=Fire)) +
  geom_point(aes(color=Region), size=2) +
  geom_smooth(method=glm,
              formula='y~x',
              se=FALSE)

p2 <- AlgForest %>%
  ggplot(aes(x=DMC, y=Fire)) +
  geom_point(aes(color=Region), size=2) +
  geom_smooth(method=glm,
              formula='y~x',
              se=FALSE)

p3 <- AlgForest %>%
  ggplot(aes(x=Ws, y=Fire)) +
  geom_point(aes(color=Region), size=2) +
  geom_smooth(formula='y~x',
              se=FALSE)

p4 <- AlgForest %>%
  ggplot(aes(x=RainYest, y=Fire)) +
  geom_point(aes(color=Region), size=2) +
  geom_smooth(se=FALSE)

ggarrange(p1, p2, p3, p4,
          #labels = c("A", "B", "C"),
          ncol = 2, nrow = 2)


par(mfrow=c(2,2))
boxplot(TempCels ~Fire*Region,data=AlgForest, boxfill=c("darkgreen","darkorange2"), xlab="", ylab="", main=("TempCels"))
boxplot(DMC      ~Fire*Region,data=AlgForest, boxfill=c("darkgreen","darkorange2"), xlab="", ylab="", main=("DMC"))
boxplot(Ws       ~Fire*Region,data=AlgForest, boxfill=c("darkgreen","darkorange2"), ylab="", main=("Ws"))
boxplot(RainYest ~Fire*Region,data=AlgForest, boxfill=c("darkgreen","darkorange2"), ylab="", main=("RainYest"), ylim=c(0,5))
par(mfrow=c(1,1))
```

```{r 2.b}

a2 <- glm(Fire~TempCels + DMC + Ws + RainYest , data=AlgForest, family=binomial(link="logit"))
# coefficients of regression after unlinking
a2.coef.unlinked <- a2 %>% coef() %>% exp()
a2 %>% coef() %>% exp() %>% round(.,3)
# Interpretation of coefficients
# odds = 1.08405  => This means that a successful outcome has almost 
# the same chance if we increase the variabe by one unit.

new.data <- data.frame(
  TempCels = c(25),
  DMC = c(40),
  Ws = c(18),
  RainYest = c(1.0))

a2.prob <- a2 %>% predict(., type="response", newdata=new.data) 
prb <- 1-a2.prob

```

```{r 2.c}

```

```{r 2.d}

```

```{r 2.e}

```
