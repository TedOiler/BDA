---
title: "Assignment2"
author: "Ted Ladas - s2124289"
date: "30/03/2021"
output: html_document
---

```{r setup, include=FALSE}
rm(list=ls())
knitr::opts_chunk$set(echo = TRUE)
library(rjags)
library(INLA)
library(dplyr)
library(data.table)
library(ggplot2)
library("ggpubr")
library(ggcorrplot)
library(gridExtra)
library(tidyr)
library(ggridges)
```

```{r 1.a(i)}
load(file='./earthScot.RData')
earthQ <- data.table(earthQ)

# EDA
numcols <- sapply(earthQ, is.numeric) 
cor.earthQ <- cor(earthQ, use="pairwise.complete")
ggcorrplot(cor.earthQ,
           hc.order=TRUE,
           type="lower",
           lab=TRUE)

plot <- earthQ %>% 
  filter(!is.na(`nrUK>4.5`))

plot %>%
  ggplot(aes(dist, eartScot,
             size=MLrUK,
             color=`nrUK>4.5`)) +
  geom_point() +
  geom_smooth(method="glm",
              formula='y~x',
              se=FALSE)

plot %>%
  ggplot(aes(decade, eartScot,
             size=MLrUK,
             color=`nrUK>4.5`)) +
  geom_point() +
  geom_smooth(method="glm",
              formula='y~x',
              se=FALSE)

plot %>%
  ggplot(., aes(eartrUK, eartScot,
                size=MLrUK,
                color=`nrUK>4.5`)) +
  geom_point() +
  geom_smooth(method="glm",
              formula='y~x',
              se=FALSE)

```

```{r 1.a(ii)}

a1 <- glm(eartScot~eartrUK, data=earthQ, family=poisson(link = "log"))
summary(a1)

earthQ %>% 
  ggplot(., aes(eartrUK, eartScot)) +
  geom_point(size=3) +
  geom_smooth(method="glm",
              formula='y~x',
              method.args=list(family=poisson(link="log")),
              se=T,
              aes(color="red4"), linetype="dashed") +
  labs(title = "Poisson Regression",
       subtitle = NULL,
       caption = NULL,
       tag = NULL,
       #x = NULL,
       #y = NULL,
       colour = "Regression") +
  theme_minimal()

# coefficients of regression after unlinking
a1.coef.unlinked <- a1 %>% coef() %>% exp()
# earthquakes during 70s and 80s
a1.fited <- a1 %>% predict(., type="response")
earthquakes.70.80 <- NULL
earthquakes.70.80 <- cbind(c(1970,1980),a1.fited[7:8])

a1.coef.unlinked
earthquakes.70.80


earthQ %>%
  dplyr::select(eartScot,eartrUK, decade) %>%
  mutate(eartScot.pred.a1 = a1.fited) %>%
  ggplot() +
  geom_point(aes(x=decade, y=eartScot, color='Actual')) +
  geom_line(aes(x=decade, y=eartScot, color='Actual')) +
  geom_point(aes(x=decade, y=eartScot.pred.a1, color='a1 Prediction')) +
  geom_line(aes(x=decade, y=eartScot.pred.a1, color='a1 Prediction')) +
  labs(title="GLM fit predictions",
       color=NULL) +
  theme_minimal()

```

```{r helper}
b.fit.transform <- function(inits=NULL, data, model, chains=3, burnin, var.names, total, thin=1){
  
  fit <- jags.model(file=textConnection(model),
                     data=data, 
                     inits=inits,
                     n.chains=chains)
  update(fit, n.iter=burnin)
  results <- coda.samples(fit,
                          variable.names=var.names,
                          n.iter=total,
                          thin=thin)
  plot(results)
  gelman.plot(results)
  for(i in 1:length(var.names)){
    acf(results[[1]][,i])
  }
  
  return(list(fit,
              results,
              gelman.diag(results),
              round(effectiveSize(results),3)))
}
```


```{r 1.b(model.s)}
model.s <- "model{
  # Hyperparameters
  a.0 <- a        
  b.0 <- b

  # prior
  lambda ~ dgamma(a.0,b.0)

 #Likelihood
  for(i in 1:n) {
      mu[i]  <- lambda*eartrUK[i]
      eartScot[i] ~ dpois(mu[i])
    } 
  }"
```


```{r 1.b(i)}
inits <- list(list(lambda=10^0),
              list(lambda=10^1),
              list(lambda=10^2),
              list(lambda=10^3),
              list(lambda=10^4))

b1.data <- list(n=length(earthQ$eartrUK),
               eartScot=earthQ$eartScot,
               eartrUK =earthQ$eartrUK,
               a=0.01,
               b=0.01)

b1 <- b.fit.transform(inits=inits,
                      data=b1.data,
                      model=model.s,
                      chains=5,
                      burnin=7000,
                      var.names=c("lambda"),
                      total=1e4)
fit.b1     <- b1[[1]]
results.b1 <- b1[[2]]
gelman.b1  <- b1[[3]]
neff.b1    <- b1[[4]]
summary(results.b1)
gelman.b1
neff.b1
```

```{r 1.b(ii)}
b2.data <- list(n=length(earthQ$eartrUK),
               eartScot=earthQ$eartScot,
               eartrUK =earthQ$eartrUK,
               a=16,
               b=20)

b2 <- b.fit.transform(inits=inits,
                      data=b2.data,
                      model=model.s,
                      chains=5,
                      burnin=7000,
                      var.names=c("lambda"),
                      total=1e4)
fit.b2     <- b2[[1]]
results.b2 <- b2[[2]]
gelman.b2  <- b2[[3]]
neff.b2    <- b2[[4]]
summary(results.b1)
gelman.b2
neff.b2
```

```{r 1.b(model.h)}
model.h <- "model{
 # Deterministic
  sigma2 = 1/tau

 # Hyperpriors
  a.0 ~ dlnorm(log(a), tau)
  b.0 ~ dlnorm(log(b), tau)
  
 # Prior
  lambda ~ dgamma(a.0,b.0)

 # Likelihood
  for(i in 1:n) {
      mu[i]  <- lambda*eartrUK[i]
      eartScot[i] ~ dpois(mu[i])
    } 
  }"
```

```{r 1.b(iii)}
inits <- list(list(lambda=10^0),
              list(lambda=10^1),
              list(lambda=10^2),
              list(lambda=10^3),
              list(lambda=10^4))

b3.data <- list(n=length(earthQ$eartrUK),
               eartScot=earthQ$eartScot,
               eartrUK =earthQ$eartrUK,
               a=2,
               b=4,
               tau=log(1.64))

b3 <- b.fit.transform(inits=inits,
                      data=b3.data,
                      model=model.h,
                      chains=5,
                      burnin=7000,
                      var.names=c("lambda", "a.0", "b.0"),
                      total=1e5,
                      thin=100)
fit.b3     <- b3[[1]]
results.b3 <- b3[[2]]
gelman.b3  <- b3[[3]]
neff.b3    <- b3[[4]]
summary(results.b3)
gelman.b3
neff.b3
```

```{r 1.c(model.c1)}
model.c1 <- "model{
 # prior
  beta0 ~ dnorm(0,1/5)
  beta1 ~ dnorm(0,1/5)

 # Likelihood
  for(i in 1:n) {
      log(mu[i]) <- beta0+beta1*(dist[i]-mean(dist[]))
      eartScot[i] ~ dpois(mu[i])
    } 
  }"
```

```{r 1.c}
c1.data <- list(n=length(earthQ$eartrUK),
               eartScot=earthQ$eartScot,
               dist =earthQ$dist)

c1 <- b.fit.transform(data=c1.data,
                      model=model.c1,
                      chains=5,
                      burnin=6000,
                      var.names=c("beta0", "beta1"),
                      total=1e4)
fit.c1     <- c1[[1]]
results.c1 <- c1[[2]]
gelman.c1  <- c1[[3]]
neff.c1    <- c1[[4]]
summary(results.c1)
gelman.c1
neff.c1
```

```{r 1.d(model.d1)}
model.d1 <- "model{
 # Likelihood
  for(i in 1:n) {
      delta[i] ~ dnorm(0,tau.delta)
      log(mu[i]) <- beta0+beta1*(dist[i]-mean(dist[])) + delta[i]
      eartScot[i] ~ dpois(mu[i])
  } 
    
 # prior
  beta0 ~ dnorm(0,1/5)
  beta1 ~ dnorm(0,1/5)
  tau.delta <- pow(sigma.delta, -2)
  sigma.delta ~ dunif(0,5)
  }"
```

```{r 1.d}
d1.data <- list(n=length(earthQ$eartrUK),
               eartScot=earthQ$eartScot,
               dist=earthQ$dist)

d1 <- b.fit.transform(data=d1.data,
                      model=model.d1,
                      chains=5,
                      burnin=6000,
                      var.names=c("beta0", "beta1", "sigma.delta"),
                      total=1e5,
                      thin=100)
fit.d1     <- d1[[1]]
results.d1 <- d1[[2]]
gelman.d1  <- d1[[3]]
neff.d1    <- d1[[4]]
summary(results.d1)
gelman.d1
neff.d1
```



```{r 1.e(model.e1)}
model.e1 <- "model{
 # prior
  beta0 ~ dnorm(0,1/5)
  beta1 ~ dnorm(0,1/5)

 # Likelihood
  for(i in 1:n) {
      log(mu[i]) <- beta0+beta1*(nrUK[i]-mean(nrUK[]))
      eartScot[i] ~ dpois(mu[i])
    } 
  }"
```


```{r 1.e imputation}
imputation <- glm(`nrUK>4.5`~ MLrUK, data=earthQ, family=poisson(link = "log"))
earthQ.imp <- earthQ %>% 
  mutate(`nrUK>4.5` = ifelse(is.na(`nrUK>4.5`),
                             round(predict(imputation, type="response"),0),
                              `nrUK>4.5`))
# earthQ.imp
```


```{r 1.e}
e1.data <- list(n=length(earthQ.imp$eartrUK),
               eartScot=earthQ.imp$eartScot,
               nrUK =earthQ.imp$`nrUK>4.5`)

e1 <- b.fit.transform(data=e1.data,
                      model=model.e1,
                      chains=5,
                      burnin=6000,
                      var.names=c("beta0", "beta1"),
                      total=1e4,
                      thin=5)
fit.e1     <- e1[[1]]
results.e1 <- e1[[2]]
gelman.e1  <- e1[[3]]
neff.e1    <- e1[[4]]
summary(results.e1)
gelman.e1
neff.e1
```

```{r 1.e(model.e2)}
model.e2 <- "model{
 # prior
  beta0 ~ dnorm(0,1/5)
  beta1 ~ dnorm(0,1/5)
  
 # Likelihood
  for(i in 1:n) {
      nrUK[i]  ~ dgamma(a.nrUK, b.nrUK)
      log(mu[i]) <- beta0+beta1*(nrUK[i]-mean(nrUK[]))
      eartScot[i] ~ dpois(mu[i])
    } 
  }"
```

```{r test}
# x <- seq(0, 5, length.out=1000)
# cv = 0.4
# cv^(-2)
# 
# dat <- data.frame(x=x, px=dgamma(x, shape = cv^(-2), rate = cv^(-2)-1))
# ggplot(dat, aes(x=x, y=px)) + geom_line()
```


```{r 1.e2}
e2.data <- list(n=length(earthQ.imp$eartrUK),
               eartScot=earthQ.imp$eartScot,
               nrUK =earthQ.imp$`nrUK>4.5`,
               a.nrUK=6.25,
               b.nrUK=5.25) # a and b chosen for mean 1 and CV 0.4

e2 <- b.fit.transform(data=e2.data,
                      model=model.e2,
                      chains=5,
                      burnin=6000,
                      var.names=c("beta0", "beta1"),
                      total=1e4,
                      thin=5)
fit.e2     <- e2[[1]]
results.e2 <- e2[[2]]
gelman.e2  <- e2[[3]]
neff.e2    <- e2[[4]]
summary(results.e2)
gelman.e2
neff.e2
```


```{r 1.e posterior predictive}
e2.params <- results.e2 %>% as.matrix(.) %>% as.data.frame(.) %>% exp(.)
e2.estimates <- colMeans(e2.params)

beta.prior <- rnorm(dim(e2.params)[1], mean=0, sd=sqrt(5))
e2.params %>%
  mutate(beta.prior = beta.prior) %>%
  ggplot() +
  geom_density(aes(beta0), fill="red4", colour="red4", alpha=0.6) +
  geom_density(aes(beta1), fill="blue4", colour="blue4", alpha=0.6) +
  geom_density(aes(beta.prior), fill="green4", colour="green4", alpha=0.6) +
  theme(axis.title.x = element_blank()) + 
  ggtitle(expression(paste("Posterior Densities of ", beta_0," and ", beta_1))) +
  #geom_text(aes(label=c("1","2","3")))

# round(e2.estimates[1] + e2.estimates[2]*earthQ.imp$`nrUK>4.5`,0) # Earthquakes according to model e2
set.seed(2)
mu.post.e2 <- e2.estimates[1] + e2.estimates[2]*earthQ.imp$`nrUK>4.5`
ynew.e2 <- as.data.frame(rpois(12, mu.post.e2))
# y.e2 %>% mutate(ynew.e2=ynew.e2+rep(1,12))


earthQ %>%
  ggplot() +
  geom_point(aes(x=decade, y=eartScot)) +
  geom_line(aes(x=decade, y=eartScot))
# plot(y,
#      main = "Posterior Predictive Distribution",
#      xlab = "y")
```



- `Region` for Bejaia and Sidi Bel-abbes
- `month` from June to September 2012
- `TempCels` Daily temperature in Celsius
- `RH` Daily relative Humidity (%)
- `Ws` Daily wind speed (Km/h)
- `RainYest` Yesterday's precipitations (mm/m^2) 
- `DMC` The Duff Moisture Code is a numeric rating of the average moisture content of loosely compacted organic layers of moderate depth in the forest. It is part of the Canadian Forest Fire Weather Index (FWI).
- `Fire` Absence/presence (0/1) of a wildfire.

```{r 2.a}
AlgForest <- read.csv('./AlgForest.csv')
AlgForest <- data.table(AlgForest)

AlgForest <- AlgForest %>%
  mutate(Fire = as.factor(Fire))


p1 <- AlgForest %>%
  ggplot(aes(x=TempCels, y=Fire)) +
  geom_point(aes(color=Region), size=2) +
  geom_smooth(method=lm,
              formula='y~x',
              se=FALSE)

p2 <- AlgForest %>%
  ggplot(aes(x=RH, y=Fire)) +
  geom_point(aes(color=Region), size=2) +
  geom_smooth(method=lm,
              formula='y~x',
              se=FALSE)

p3 <- AlgForest %>%
  ggplot(aes(x=Ws, y=Fire)) +
  geom_point(aes(color=Region), size=2) +
  geom_smooth(method=lm,
              formula='y~x',
              se=FALSE)

p4 <- AlgForest %>%
  ggplot(aes(x=RainYest, y=Fire)) +
  geom_point(aes(color=Region), size=2) +
  geom_smooth(method=lm,
              formula='y~x',
              se=FALSE)

ggarrange(p1, p2, p3, p4, ncol=2, nrow=2)


par(mfrow=c(2,2))
boxplot(TempCels ~ Fire*Region, data=AlgForest, boxfill=c("darkgreen","darkorange2"), xlab="", ylab="", main=("TempCels"))
boxplot(RH       ~ Fire*Region, data=AlgForest, boxfill=c("darkgreen","darkorange2"), xlab="", ylab="", main=("RH"))
boxplot(Ws       ~ Fire*Region, data=AlgForest, boxfill=c("darkgreen","darkorange2"), ylab="", main=("Ws"))
boxplot(RainYest ~ Fire*Region, data=AlgForest, boxfill=c("darkgreen","darkorange2"), ylab="", main=("RainYest"),ylim=c(0,5))
par(mfrow=c(1,1))
```

```{r 2.b}

a2 <- glm(Fire~TempCels + RH + Ws + RainYest , data=AlgForest, family=binomial(link="logit"))
# coefficients of regression after unlinking
a2.coef.unlinked <- a2 %>% coef() %>% exp()
a2 %>% coef() %>% exp() %>% round(.,3)
# Interpretation of coefficients
# odds = 1.08405  => This means that a successful outcome has almost 
# the same chance if we increase the variabe by one unit.

new.data <- data.frame(
  TempCels = c(25),
  RH = c(40),
  Ws = c(18),
  RainYest = c(1.0))

a2.prob <- a2 %>% predict(., type="response", newdata=new.data) 
prb <- 1-a2.prob
```

```{r 2.c function - inv.logit}
inv.logit <- function(x) {
  return(1/(1+exp(-x)))
}
```


```{r 2.c(models b)}
model.c2 <- "model{
  # prior
  beta0 ~ dnorm(0,1/100)
  beta1 ~ dnorm(0,1/100)
  beta2 ~ dnorm(0,1/100)
  beta3 ~ dnorm(0,1/100)
  beta4 ~ dnorm(0,1/100)

 #Likelihood
  for(i in 1:n) {
      logit(mu[i]) <- -(beta0 + 
                        beta1*TempCels[i] + 
                        beta2*RH[i] + 
                        beta3*Ws[i] + 
                        beta4*RainYest[i])
      Fire[i] ~ dbern(mu[i])
    }
  }"
```

```{r 2.c}
AlgForest <- AlgForest %>% mutate(Fire=as.numeric(Fire)-1)

inits.c2 <- list(list(beta0=0, beta1=0, beta2=0, beta3=0, beta4=0),
                 list(beta0=0, beta1=0, beta2=0, beta3=0, beta4=0),
                 list(beta0=0, beta1=0, beta2=0, beta3=0, beta4=0),
                 list(beta0=0, beta1=0, beta2=0, beta3=0, beta4=0),
                 list(beta0=0, beta1=0, beta2=0, beta3=0, beta4=0))

c2.data <- list(n=length(AlgForest$Fire),
               Fire=AlgForest$Fire,
               TempCels=AlgForest$TempCels,
               RH=AlgForest$RH,
               Ws=AlgForest$Ws,
               RainYest=AlgForest$RainYest)

c2 <- b.fit.transform(data=c2.data,
                      model=model.c2,
                      chains=3,
                      burnin=2000,
                      var.names=c("beta0", "beta1", "beta2", "beta3", "beta4"),
                      total=5e4,
                      thin=100)
fit.c2     <- c2[[1]]
results.c2 <- c2[[2]]
gelman.c2  <- c2[[3]]
neff.c2    <- c2[[4]]
summary(results.c2)
gelman.c2
neff.c2
```

```{r 2.c(results)}
coefficients.c2 <- colMeans(exp(results.c2[[1]]))
# coefficients.c2.low <- colMeans(exp(results.c2[[1]]))
# coefficients.c2.high <- 
fire <- sum(coefficients.c2*c(1,35,40,18,1))
result <- ppois(1:100,lambda=fire)
```



```{r 2.d(model.d1)}
model.d1 <- "model{
  # Likelihood
  for(i in 1:n) {
      Fire[i] ~ dbern(mu[i])
      logit(mu[i]) <- -(beta0[j.region[i]] + 
                        beta1*TempCels[i] + 
                        beta2*RH[i] + 
                        beta3*Ws[i] + 
                        beta4*RainYest[i])
  }
  
  # priors for independent intercepts per county
  for(j in 1:J){
    beta0[j] ~ dnorm(0,1/0.1)
  }
  # prior
  beta1 ~ dnorm(0,1/100)
  beta2 ~ dnorm(0,1/100)
  beta3 ~ dnorm(0,1/100)
  beta4 ~ dnorm(0,1/100)
  }"
```

```{r 2.d(i)}
AlgForest.region <- AlgForest %>% 
  mutate(j.region=if_else(Region=="B",1,2))

d1.data <- list(n=length(AlgForest.region$Fire),
               Fire=AlgForest.region$Fire,
               TempCels=AlgForest.region$TempCels,
               RH=AlgForest.region$RH,
               Ws=AlgForest.region$Ws,
               RainYest=AlgForest.region$RainYest,
               j.region=AlgForest.region$j.region,
               J=2)

d1 <- b.fit.transform(data=d1.data,
                      model=model.d1,
                      chains=5,
                      burnin=7000,
                      var.names=c("beta0[1]", "beta0[2]", "beta1", "beta2", "beta3", "beta4"),
                      total=5e4,
                      thin=100)
fit.d1     <- d1[[1]]
results.d1 <- d1[[2]]
gelman.d1  <- d1[[3]]
neff.d1    <- d1[[4]]
summary(results.d1)
gelman.d1
neff.d1
```


```{r 2.d(model.d2)}
model.d2 <- "model{
  # Likelihood
  for(i in 1:n) {
      Fire.rep[i] ~ dbern(mu[i])
      Fire[i] ~ dbern(mu[i])
      logit(mu[i]) <- -(beta0[j.region[i]] + 
                        beta1*TempCels[i] + 
                        beta2*RH[i] + 
                        beta3*Ws[i] + 
                        beta4*RainYest[i] +
                        beta5[j.region[i]]*month.b[i])
  }
  # priors for independent intercepts per county
  for(j in 1:J){
    beta0[j] ~ dnorm(0,1/0.1)
    beta5[j] ~ dnorm(0,1/0.1)
  }
  # prior
  beta1 ~ dnorm(0,1/100)
  beta2 ~ dnorm(0,1/100)
  beta3 ~ dnorm(0,1/100)
  beta4 ~ dnorm(0,1/100)
  }"
```


```{r 2.d(ii)}
AlgForest.month <- AlgForest.region %>% 
  mutate(month.b=if_else(month %in% c(7,8), "July&August","June&September"),
         month.b=as.factor(month.b))

d2.data <- list(n=length(AlgForest.month$Fire),
               Fire=AlgForest.month$Fire,
               TempCels=AlgForest.month$TempCels,
               RH=AlgForest.month$RH,
               Ws=AlgForest.month$Ws,
               RainYest=AlgForest.month$RainYest,
               j.region=AlgForest.month$j.region,
               month.b=AlgForest.month$month.b,
               J=2)

d2 <- b.fit.transform(data=d2.data,
                      model=model.d2,
                      chains=5,
                      burnin=2000,
                      var.names=c("beta0[1]", "beta0[2]", "beta1", "beta2", "beta3", "beta4", "beta5[1]", "beta5[2]"),
                      total=5e4,
                      thin=100)
fit.d2     <- d2[[1]]
results.d2 <- d2[[2]]
gelman.d2  <- d2[[3]]
neff.d2    <- d2[[4]]
summary(results.d2)
gelman.d2
neff.d2
```

```{r 2.d(model.d3)}
model.d3 <- "model{
  # Likelihood
  for(i in 1:n) {
      Fire.rep[i] ~ dbern(mu[i])
      Fire[i] ~ dbern(mu[i])
      logit(mu[i]) <- -(beta0[region.month[i]] + 
                        beta1*TempCels[i] + 
                        beta2*RH[i] + 
                        beta3*Ws[i] + 
                        beta4*RainYest[i]) +
                        omega[region.month[i]]
  }
  
  # priors for independent intercepts per county
  for(j in 1:J){
    beta0[j] ~ dnorm(0, 1/0.1)
    omega[j] ~ dgamma(0.01,0.01)
  }
  # prior
  beta1 ~ dnorm(0,1/100)
  beta2 ~ dnorm(0,1/100)
  beta3 ~ dnorm(0,1/100)
  beta4 ~ dnorm(0,1/100)
}"
```

```{r 2.d(iii)}
AlgForest.region.month <- AlgForest %>% 
  mutate(region.month=case_when(Region=="B" & month==6 ~ 1,
                                Region=="B" & month==7 ~ 2,
                                Region=="B" & month==8 ~ 3,
                                Region=="B" & month==9 ~ 4,
                                Region=="S" & month==6 ~ 5,
                                Region=="S" & month==7 ~ 6,
                                Region=="S" & month==8 ~ 7,
                                Region=="S" & month==9 ~ 8))

d3.data <- list(n=length(AlgForest.region.month$Fire),
               Fire=AlgForest.region.month$Fire,
               TempCels=AlgForest.region.month$TempCels,
               RH=AlgForest.region.month$RH,
               Ws=AlgForest.region.month$Ws,
               RainYest=AlgForest.region.month$RainYest,
               region.month=AlgForest.region.month$region.month,
               J=max(AlgForest.region.month$region.month))

d3 <- b.fit.transform(data=d3.data,
                      model=model.d3,
                      chains=5,
                      burnin=2000,
                      var.names=c("omega[1]","omega[2]","omega[3]","omega[4]",
                                  "omega[5]","omega[6]","omega[7]","omega[8]",
                                  "beta0[1]","beta0[2]","beta0[3]","beta0[4]",
                                  "beta0[5]","beta0[6]","beta0[7]","beta0[8]",
                                  "beta1","beta2","beta3","beta4"),
                      total=5e4,
                      thin=100)
fit.d3     <- d3[[1]]
results.d3 <- d3[[2]]
gelman.d3  <- d3[[3]]
neff.d3    <- d3[[4]]
summary(results.d3)
gelman.d3
neff.d3
```

```{r}
# warts.ident.model <- "model{
# #likelihood
#   for(i in 1:n){
#     warts[i] ~ dbinom(p, consults[i])
#     warts.pred[i] ~ dbinom(p, consults[i])
#   }
# # prior for the probability
#   logit(p) <- beta0
#   beta0 ~ dnorm(0, 0.0025)
#  }"
# 
# prior.beta <- list(mean.intercept = 0, prec.intercept = 1/(20^2))
# m.warts.identical=inla(warts~1,data=wartpid.data,family="binomial",
#                        control.family=list(link="logit"),
#                        Ntrials=consults,
#                        control.fixed=prior.beta,
#                        control.compute=list(config=TRUE,cpo=TRUE,dic=TRUE))
# #Including control.compute=list(config=TRUE,cpo=TRUE,dic=TRUE
# #allows for posterior sampling, and computes CPO and DIC values
# 
# summary(m.warts.identical)
```

```{r 2.d(iii) INLA model}
model.d3 <- "model{
  # Likelihood
  for(i in 1:n) {
      Fire.rep[i] ~ dbern(mu[i])
      Fire[i] ~ dbern(mu[i])
      logit(mu[i]) <- -(beta0[region.month[i]] +
                        beta1*TempCels[i] +
                        beta2*RH[i] +
                        beta3*Ws[i] +
                        beta4*RainYest[i])
  }

  # priors for independent intercepts per county
  for(j in 1:J){
    beta0[j] ~ dnorm(0, omega)
  }
  # prior
  omega ~ dgamma(0.01,0.01)
  beta1 ~ dnorm(0,1/100)
  beta2 ~ dnorm(0,1/100)
  beta3 ~ dnorm(0,1/100)
  beta4 ~ dnorm(0,1/100)
}"

prior.gamma <- list(prec=list(prior = "gamma", param = c(0.1, 0.1)))
prior.beta <- list(mean.intercept = 0, prec.intercept = 1/(10^2))

results.d3.inla=inla(Fire~region.month+TempCels+RH+Ws+RainYest,
                     data=AlgForest.region.month,
                     family="binomial",
                     Ntrials=1,
                     control.family=list(link="logit"),
                     control.fixed=prior.beta,
                     control.inla = list(strategy = "laplace", npoints = 40),
                     control.compute=list(config=TRUE,cpo=TRUE,dic=TRUE))

summary(results.d3.inla)

```


```{r 2.d results}
# i
results.d1.df <- data.frame(results.d1[[1]])
prob.d1.B <- round(mean(inv.logit(results.d1.df$beta0.1.)),3) # B
prob.d1.S <- round(mean(inv.logit(results.d1.df$beta0.2.)),3) # S

results.d1.df %>% 
  ggplot() +
  geom_density(aes(x=inv.logit(beta0.1.)), fill="red4"  , color="red4"  , alpha=0.5) +
  geom_density(aes(x=inv.logit(beta0.2.)), fill="green4", color="green4", alpha=0.5)
  
# ii
results.d2.df <- data.frame(results.d2[[1]])
prob.d2.B <- round(mean(inv.logit(results.d2.df$beta0.1.)),3) # B
prob.d2.S <- round(mean(inv.logit(results.d2.df$beta0.2.)),3) # S

prob.d2.78 <- round(mean(inv.logit(results.d2.df$beta5.1.)),3) 
prob.d2.69 <- round(mean(inv.logit(results.d2.df$beta5.2.)),3) 

# iii
results.d3.df <- data.frame(results.d3[[1]])
prob.d3.B.6 <- round(mean(inv.logit(results.d3.df$beta0.1.)),3)
prob.d3.B.7 <- round(mean(inv.logit(results.d3.df$beta0.2.)),3)
prob.d3.B.8 <- round(mean(inv.logit(results.d3.df$beta0.3.)),3)
prob.d3.B.9 <- round(mean(inv.logit(results.d3.df$beta0.4.)),3)
prob.d3.S.6 <- round(mean(inv.logit(results.d3.df$beta0.5.)),3)
prob.d3.S.7 <- round(mean(inv.logit(results.d3.df$beta0.6.)),3)
prob.d3.S.8 <- round(mean(inv.logit(results.d3.df$beta0.7.)),3)
prob.d3.S.9 <- round(mean(inv.logit(results.d3.df$beta0.8.)),3)

d3.1 <- results.d3.df %>% 
  ggplot() +
  geom_density(aes(x=inv.logit(beta0.1.)), fill="red4"  , color="red4"  , alpha=0.5) +
  geom_density(aes(x=inv.logit(beta0.5.)), fill="green4", color="green4", alpha=0.5) +
  labs(title="June", x=NULL, y=NULL)

d3.2 <- results.d3.df %>% 
  ggplot() +
  geom_density(aes(x=inv.logit(beta0.2.)), fill="red4"  , color="red4"  , alpha=0.5) +
  geom_density(aes(x=inv.logit(beta0.6.)), fill="green4", color="green4", alpha=0.5) +
  labs(title="July", x=NULL, y=NULL)

d3.3 <- results.d3.df %>% 
  ggplot() +
  geom_density(aes(x=inv.logit(beta0.3.)), fill="red4"  , color="red4"  , alpha=0.5) +
  geom_density(aes(x=inv.logit(beta0.7.)), fill="green4", color="green4", alpha=0.5) +
  labs(title="August", x=NULL, y=NULL)

d3.4 <- results.d3.df %>% 
  ggplot() +
  geom_density(aes(x=inv.logit(beta0.4.)), fill="red4"  , color="red4"  , alpha=0.5) +
  geom_density(aes(x=inv.logit(beta0.8.)), fill="green4", color="green4", alpha=0.5) +
  labs(title="Sepember", x=NULL, y=NULL)

ggarrange(d3.1, d3.2, d3.3, d3.4, ncol=2, nrow=2, common.legend=TRUE) %>%
  annotate_figure(top=text_grob("Fires per region per month"))

```


```{r 2.e(model.e1)}
model.e1 <- "model{
  # Likelihood
  for(i in 1:n) {
      Fire.rep[i] ~ dbern(mu[i])
      Fire[i] ~ dbern(mu[i])
      logit(mu[i]) <- -(beta0[region.month[i]] + 
                        beta1*TempCels[i] + 
                        beta2*DMC[i] + 
                        beta3*Ws[i] + 
                        beta4*RainYest[i] +
                        beta5*RH[i])
  }
  
  # priors for independent intercepts per county
  for(j in 1:J){
    beta0[j] ~ dnorm(0, omega)
  }
  # prior
  omega ~ dgamma(0.01,0.01)
  beta1 ~ dnorm(0,1/100)
  beta2 ~ dnorm(0,1/100)
  beta3 ~ dnorm(0,1/100)
  beta4 ~ dnorm(0,1/100)
  beta5 ~ dnorm(0,1/100)
}"
```

```{r 2.e fit e1}
e1.data <- list(n=length(AlgForest.region.month$Fire),
               Fire=AlgForest.region.month$Fire,
               TempCels=AlgForest.region.month$TempCels,
               RH=AlgForest.region.month$RH,
               Ws=AlgForest.region.month$Ws,
               RainYest=AlgForest.region.month$RainYest,
               DMC=AlgForest.region.month$DMC,
               region.month=AlgForest.region.month$region.month,
               J=max(AlgForest.region.month$region.month))

e1 <- b.fit.transform(data=e1.data,
                      model=model.e1,
                      chains=5,
                      burnin=7000,
                      var.names=c("omega","beta1","beta2","beta3","beta4","beta5",
                                            "beta0[1]","beta0[2]","beta0[3]","beta0[4]",
                                            "beta0[5]","beta0[6]","beta0[7]","beta0[8]"),
                      total=1e4)
fit.e1     <- e1[[1]]
results.e1 <- e1[[2]]
gelman.e1  <- e1[[3]]
neff.e1    <- e1[[4]]
summary(results.e1)
gelman.e1
neff.e1
```



```{r 2.e formula - compute.replicates()}
compute.replicates <- function(fit, iter, var.name, chains) {
  fit.samples <- NULL
  res.fit <- coda.samples(fit,
                          variable.names=c(var.name),
                          n.iter=iter)
  for(i in 1:chains){
    fit.samples <- rbind(fit.samples, res.fit[[i]])
  }
  fit.samples <- data.frame(fit.samples) 
  return(fit.samples)
}
```

```{r 2.e formula - replicates.tidy()}
replicates.tidy <- function(res){
  df <- transpose(res) %>%
  mutate(Region = AlgForest$Region,
         month = AlgForest$month) %>%
  relocate(Region, month) %>%
  group_by(Region, month) %>%
  summarise_all(sum)  %>% 
  pivot_longer(cols=-c(Region, month), names_to="index", values_to="total.fires") %>%
  mutate(region.month=paste(Region, month)) %>%
  relocate(region.month)
  return(df)
}
```

```{r  2.e formula - calculate.prob()}
calculate.prob <- function(resample, original){
  prob.table <- left_join(x=resample, y=original, by="region.month") 
  prob.final <- prob.table %>%
    group_by(region.month) %>%
    mutate(prob=sum(total.fires>name)/(chains*iter)) %>%
    distinct(region.month, prob)
  return(prob.final)
}
```


```{r 2.e}
chains = 5
iter = 1e4
res.d2 <- compute.replicates(fit=fit.d2, iter=iter, var.name="Fire.rep", chains=chains)
res.d3 <- compute.replicates(fit=fit.d3, iter=iter, var.name="Fire.rep", chains=chains)
res.e1 <- compute.replicates(fit=fit.e1, iter=iter, var.name="Fire.rep", chains=chains)

fire.rm.oj <- AlgForest %>%
  group_by(Region, month) %>%
  summarise_at(vars(Fire),    
               list(name=sum)) %>%
  mutate(region.month=paste(Region, month)) %>%
  relocate(region.month) %>% 
  ungroup() %>% 
  select(region.month, name)

fire.rm.d2 <- replicates.tidy(res=res.d2)
fire.rm.d3 <- replicates.tidy(res=res.d3)
fire.rm.e1 <- replicates.tidy(res=res.e1)

# ggplot of densities per region per month
d1 <- fire.rm.d2 %>% ggplot(aes(x=total.fires, y=as.factor(region.month), fill=Region, height=stat(density))) +
  geom_density_ridges(stat = "binline", bins=30, draw_baseline = FALSE) +
  geom_segment(data=fire.rm.oj,
               aes(x=name, xend=name,
                   y=as.numeric(as.factor(region.month)),
                   yend=as.numeric(as.factor(region.month))+1.5),
             color = "red", inherit.aes = F) +
  theme(legend.position="none") +
  labs(y="Region-month", x="Total Fires", title="Model d2")

d2 <- fire.rm.d3 %>% ggplot(aes(x=total.fires, y=as.factor(region.month), fill=Region, height=stat(density))) +
  geom_density_ridges(stat = "binline", bins=30, draw_baseline = FALSE) +
  geom_segment(data=fire.rm.oj,
               aes(x=name, xend=name,
                   y=as.numeric(as.factor(region.month)),
                   yend=as.numeric(as.factor(region.month))+1.5),
             color = "red", inherit.aes = F) +
  theme(legend.position="none",
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  labs(x="Total Fires", title="Model d3")

d3 <- fire.rm.e1 %>% ggplot(aes(x=total.fires, y=as.factor(region.month), fill=Region, height=stat(density))) +
  geom_density_ridges(stat = "binline", bins=30, draw_baseline = FALSE) +
  geom_segment(data=fire.rm.oj,
               aes(x=name, xend=name,
                   y=as.numeric(as.factor(region.month)),
                   yend=as.numeric(as.factor(region.month))+1.5),
             color = "red", inherit.aes = F) +
  theme(legend.position="none",
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  labs(x="Total Fires", title="Model e1")

ggarrange(d1, d2, d3, ncol=3, nrow=1) %>% annotate_figure(top=text_grob("Distribution of wild fires per region per month"))

# compute the probability
calculate.prob(resample=fire.rm.d2, original=fire.rm.oj)
calculate.prob(resample=fire.rm.d3, original=fire.rm.oj)
calculate.prob(resample=fire.rm.e1, original=fire.rm.oj)

# compute dic scores

dic.d2 <- dic.samples(fit.d2, n.iter=1e3)
dic.d3 <- dic.samples(fit.d3, n.iter=1e3)
dic.e1 <- dic.samples(fit.e1, n.iter=1e3)
dic.d2
dic.d3
dic.e1


# predict on new data
results.e1.pr <- inv.logit(do.call(rbind.data.frame, results.e1)) %>% data.frame() 

#last => find the gamma prior that has variance 20-7=13 and mean (12+10)/2=11
```

```{r test}
# 
# # probability of new data
# newdata <- data.frame(region.month=c(8,4),
#                       TempCels=c(26,24),
#                       DMC=c(12,8),
#                       Ws=c(13,15),
#                       RainYest=c(0.0,0.5),
#                       RH=c(20,40))
# 
# # p11 <- 1/(1+ exp(-nu11) ) #inverse-logit
# # mu <- exp(results.d2$`beta0[1]`)
# results.e1.pr <- 1/(1+exp(do.call(rbind.data.frame, results.e1)))
# param.exp <- colMeans(results.e1.pr)
# 
# pr.result <- param.exp[8] + 
#     param.exp[9]*newdata$TempCels + 
#     param.exp[10]*newdata$DMC +
#     param.exp[11]*newdata$Ws +
#     param.exp[12]*newdata$RainYest+
#     param.exp[13]*newdata$RH
# 
# pr.result
# 
```
